<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>Trading Strategy Controller v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(214.3 31.8% 91.4%)",
                        input: "hsl(214.3 31.8% 91.4%)",
                        ring: "hsl(222.2 84% 4.9%)",
                        background: "hsl(0 0% 100%)",
                        foreground: "hsl(222.2 84% 4.9%)",
                        primary: {
                            DEFAULT: "hsl(222.2 47.4% 11.2%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        secondary: {
                            DEFAULT: "hsl(210 40% 96%)",
                            foreground: "hsl(222.2 84% 4.9%)",
                        },
                        destructive: {
                            DEFAULT: "hsl(0 84.2% 60.2%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        muted: {
                            DEFAULT: "hsl(210 40% 96%)",
                            foreground: "hsl(215.4 16.3% 46.9%)",
                        },
                        accent: {
                            DEFAULT: "hsl(210 40% 96%)",
                            foreground: "hsl(222.2 84% 4.9%)",
                        },
                        popover: {
                            DEFAULT: "hsl(0 0% 100%)",
                            foreground: "hsl(222.2 84% 4.9%)",
                        },
                        card: {
                            DEFAULT: "hsl(0 0% 100%)",
                            foreground: "hsl(222.2 84% 4.9%)",
                        },
                    },
                }
            }
        }
    </script>
    <style>
        /* Remove spinners from number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-background text-foreground">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="space-y-6">
            <!-- Header -->
            <div class="border-b pb-4">
                <h1 class="text-3xl font-bold tracking-tight">Trading Algorithm Controller</h1>
            </div>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button id="backtest-tab" class="tab-button active bg-white py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" onclick="switchTab('backtest')">
                        Backtest
                    </button>
                    <button id="config-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="switchTab('config')">
                        Configuration
                    </button>
                </nav>
            </div>

            <!-- Backtest Content -->
            <div id="backtest-content" style="display: block;">
            
            <!-- Status Card -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold">Status</h3>
                            <p class="text-sm text-muted-foreground">Current backtest status</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <span id="status-text" class="font-medium">Idle</span>
                        </div>
                    </div>
                    <div id="status-details" class="mt-4 space-y-2 text-sm text-muted-foreground">
                        <!-- Status details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Controls Card -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-4">Controls</h3>
                    <div class="flex space-x-4">
                        <button id="start-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                            Start Backtest
                        </button>
                        <button id="stop-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-10 px-4 py-2" disabled>
                            Stop Backtest
                        </button>
                        <button id="download-report-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" disabled>
                            Download Backtest Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section (Hidden by default) -->
            <div id="results-section" class="space-y-6" style="display: none;">
                <!-- Statistics Overview -->
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">üìä Performance Statistics</h3>
                        <div id="stats-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Stats will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Equity Curve Chart -->
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">üìà Equity Curve</h3>
                        <div id="equity-chart" style="height: 400px;"></div>
                    </div>
                </div>


                <!-- Orders Table -->
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">üìã Trade History</h3>
                        <div id="orders-table" class="overflow-x-auto">
                            <!-- Orders table will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            </div> <!-- End backtest-content -->

            <!-- Configuration Content -->
            <div id="config-content" style="display: none;">
                <div class="space-y-6">

                    <!-- Configuration Form -->
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold">Trading Strategy Configuration</h3>
                                <div id="save-status" class="text-sm text-gray-600">
                                    Auto-save: Ready
                                </div>
                            </div>
                            <form id="configForm" class="space-y-8">
                                        
                                        <!-- General Parameters -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-blue-800">‚öôÔ∏è General Parameters</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Starting Cash:</label>
                                                    <input type="number" id="starting_cash" name="starting_cash" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Start Date (YYYY-MM-DD):</label>
                                                    <input type="text" id="start_date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">End Date (YYYY-MM-DD):</label>
                                                    <input type="text" id="end_date" name="end_date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Symbols -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-green-800">üìä Trading Symbols</h4>
                                            
                                            <!-- Add Symbol Input -->
                                            <div class="flex space-x-2">
                                                <input type="text" id="new-symbol-input" placeholder="Enter symbol (e.g., AAPL)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md uppercase" maxlength="10">
                                                <button type="button" id="add-symbol-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                    Add Symbol
                                                </button>
                                            </div>
                                            
                                            <!-- Current Symbols Display -->
                                            <div>
                                                <label class="block text-sm font-medium mb-2">Current Symbols:</label>
                                                <div id="symbols-container" class="min-h-20 p-3 border border-gray-300 rounded-md bg-gray-50">
                                                    <!-- Symbols will be displayed here as badges -->
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden input for form submission -->
                                            <input type="hidden" id="symbols" name="symbols" value="">
                                            
                                            <!-- Quick Add Common Symbols -->
                                            <div>
                                                <label class="block text-sm font-medium mb-2">Quick Add Popular Symbols:</label>
                                                <div class="flex flex-wrap gap-2">
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="SPY">SPY</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="QQQ">QQQ</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="IWM">IWM</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="AAPL">AAPL</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="MSFT">MSFT</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="GOOGL">GOOGL</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="AMZN">AMZN</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="TSLA">TSLA</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="NVDA">NVDA</button>
                                                    <button type="button" class="quick-add-symbol px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md" data-symbol="META">META</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Core Trading Parameters -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-blue-700">üìä Core Trading Parameters</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Parameter 1:</label>
                                                    <input type="number" id="Parameter_1" name="Parameter_1" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Parameter 2:</label>
                                                    <input type="number" id="Parameter_2" name="Parameter_2" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Parameter 3:</label>
                                                    <input type="number" id="Parameter_3" name="Parameter_3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Parameter 4:</label>
                                                    <input type="number" id="Parameter_4" name="Parameter_4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Parameter 5:</label>
                                                    <input type="number" id="Parameter_5" name="Parameter_5" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Condition Enablement -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-green-700">üîò Condition Enablement</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox" id="C1" name="C1" class="rounded">
                                                    <label for="C1" class="text-sm font-medium">Enable Condition 1</label>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox" id="C2" name="C2" class="rounded">
                                                    <label for="C2" class="text-sm font-medium">Enable Condition 2</label>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox" id="C3" name="C3" class="rounded">
                                                    <label for="C3" class="text-sm font-medium">Enable Condition 3</label>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox" id="C4" name="C4" class="rounded">
                                                    <label for="C4" class="text-sm font-medium">Enable Condition 4</label>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox" id="C5" name="C5" class="rounded">
                                                    <label for="C5" class="text-sm font-medium">Enable Condition 5</label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Profit Take Settings -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-emerald-700">üí∞ Profit Take Settings</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Profit Take C1 (%):</label>
                                                    <input type="number" id="ProfitTakeC1" name="ProfitTakeC1" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Profit Take C2 (%):</label>
                                                    <input type="number" id="ProfitTakeC2" name="ProfitTakeC2" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Profit Take C3 (%):</label>
                                                    <input type="number" id="ProfitTakeC3" name="ProfitTakeC3" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Profit Take C4 (%):</label>
                                                    <input type="number" id="ProfitTakeC4" name="ProfitTakeC4" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Profit Take C5 (%):</label>
                                                    <input type="number" id="ProfitTakeC5" name="ProfitTakeC5" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Risk Management -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-red-700">üõ°Ô∏è Risk Management</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss (%):</label>
                                                    <input type="number" id="StopLoss" name="StopLoss" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Shares to Sell (%):</label>
                                                    <input type="number" id="SharesToSell" name="SharesToSell" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Offset PCT:</label>
                                                    <input type="number" id="OffsetPCT" name="OffsetPCT" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Timing Constraints -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-purple-700">‚è±Ô∏è Timing Constraints</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Same Symbol Time:</label>
                                                    <input type="number" id="SameSymbolTime" name="SameSymbolTime" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Same Condition Time C1:</label>
                                                    <input type="number" id="SameConditionTimeC1" name="SameConditionTimeC1" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Same Condition Time C2:</label>
                                                    <input type="number" id="SameConditionTimeC2" name="SameConditionTimeC2" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Same Condition Time C3:</label>
                                                    <input type="number" id="SameConditionTimeC3" name="SameConditionTimeC3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Same Condition Time C4:</label>
                                                    <input type="number" id="SameConditionTimeC4" name="SameConditionTimeC4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Same Condition Time C5:</label>
                                                    <input type="number" id="SameConditionTimeC5" name="SameConditionTimeC5" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>


                                        <!-- Stop Loss Update -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-red-600">üîÑ Stop Loss Update</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss Update:</label>
                                                    <input type="number" id="StopLossUpdate" name="StopLossUpdate" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Stop Loss X/Y Parameters -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-pink-700">üìê Stop Loss X/Y Parameters</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss X C1:</label>
                                                    <input type="number" id="StopLossXC1" name="StopLossXC1" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss Y C1:</label>
                                                    <input type="number" id="StopLossYC1" name="StopLossYC1" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss X C2:</label>
                                                    <input type="number" id="StopLossXC2" name="StopLossXC2" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss Y C2:</label>
                                                    <input type="number" id="StopLossYC2" name="StopLossYC2" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss X C3:</label>
                                                    <input type="number" id="StopLossXC3" name="StopLossXC3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss Y C3:</label>
                                                    <input type="number" id="StopLossYC3" name="StopLossYC3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss X C4:</label>
                                                    <input type="number" id="StopLossXC4" name="StopLossXC4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss Y C4:</label>
                                                    <input type="number" id="StopLossYC4" name="StopLossYC4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss X C5:</label>
                                                    <input type="number" id="StopLossXC5" name="StopLossXC5" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Stop Loss Y C5:</label>
                                                    <input type="number" id="StopLossYC5" name="StopLossYC5" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>


                                        <!-- Capital Management -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-indigo-700">üíé Capital Management</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Cash PCT (%):</label>
                                                    <input type="number" id="cash_pct" name="cash_pct" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Max Capital PCT (%):</label>
                                                    <input type="number" id="MaxCapitalPCT" name="MaxCapitalPCT" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- VWAP Settings -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-cyan-700">üìä VWAP Settings</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">VWAP PCT:</label>
                                                    <input type="number" id="VWAP_PCT" name="VWAP_PCT" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">VWAP Margin:</label>
                                                    <input type="number" id="Vwap_Margin" name="Vwap_Margin" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Rally Conditions -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-teal-700">üöÄ Rally Conditions</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Rally X Min PCT:</label>
                                                    <input type="number" id="Rally_X_Min_PCT" name="Rally_X_Min_PCT" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Rally X Max PCT:</label>
                                                    <input type="number" id="Rally_X_Max_PCT" name="Rally_X_Max_PCT" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Rally Y PCT:</label>
                                                    <input type="number" id="Rally_Y_PCT" name="Rally_Y_PCT" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Rally Time Constraint:</label>
                                                    <input type="number" id="Rally_Time_Constraint" name="Rally_Time_Constraint" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Rally Time Constraint Threshold:</label>
                                                    <input type="number" id="Rally_Time_Constraint_Threshold" name="Rally_Time_Constraint_Threshold" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Action Timing -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-slate-700">‚è∞ Action Timing</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div class="flex items-center space-x-2">
                                                    <input type="checkbox" id="Allow_Actions" name="Allow_Actions" class="rounded">
                                                    <label for="Allow_Actions" class="text-sm font-medium">Allow Actions</label>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Action 1 Time:</label>
                                                    <input type="number" id="Action1_Time" name="Action1_Time" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Action 2 Time:</label>
                                                    <input type="number" id="Action2_Time" name="Action2_Time" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Market Hours -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-amber-700">üïê Market Hours</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Algo Off Before:</label>
                                                    <input type="text" id="Algo_Off_Before" name="Algo_Off_Before" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Algo Off After:</label>
                                                    <input type="text" id="Algo_Off_After" name="Algo_Off_After" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Daily Limits -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-rose-700">üìà Daily Limits</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Max Daily PNL:</label>
                                                    <input type="number" id="Max_Daily_PNL" name="Max_Daily_PNL" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>


                                        <!-- Advanced Settings -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-semibold border-b pb-2 text-emerald-800">üîß Advanced Settings</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">New Range Order Cancellation Margin:</label>
                                                    <input type="number" id="New_Range_Order_Cancellation_Margin" name="New_Range_Order_Cancellation_Margin" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Range Multiple Threshold:</label>
                                                    <input type="number" id="RangeMultipleThreshold" name="RangeMultipleThreshold" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Liquidity Threshold:</label>
                                                    <input type="number" id="Liquidity_Threshold" name="Liquidity_Threshold" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Gap Threshold:</label>
                                                    <input type="number" id="Gap_Threshold" name="Gap_Threshold" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Sharp Movement Threshold:</label>
                                                    <input type="number" id="SharpMovement_Threshold" name="SharpMovement_Threshold" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium mb-1">Sharp Movement Minutes:</label>
                                                    <input type="number" id="SharpMovement_Minutes" name="SharpMovement_Minutes" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                                </div>
                                            </div>
                                        </div>
                                
                            </form>
                        </div>
                    </div>
                </div>
            </div> <!-- End config-content -->

        </div>
    </div>

    <script>
        // Global variables
        let statusInterval = null;
        let currentSymbols = [];
        let currentResults = null;
        let currentConfig = null;

        // Tab switching functionality
        function switchTab(tab) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Hide all content
            document.getElementById('backtest-content').style.display = 'none';
            document.getElementById('config-content').style.display = 'none';
            
            // Show selected content and activate tab
            if (tab === 'backtest') {
                document.getElementById('backtest-content').style.display = 'block';
                document.getElementById('backtest-tab').classList.add('active', 'bg-white', 'border-blue-500', 'text-blue-600');
                document.getElementById('backtest-tab').classList.remove('border-transparent', 'text-gray-500');
                startStatusPolling();
            } else if (tab === 'config') {
                document.getElementById('config-content').style.display = 'block';
                document.getElementById('config-tab').classList.add('active', 'bg-white', 'border-blue-500', 'text-blue-600');
                document.getElementById('config-tab').classList.remove('border-transparent', 'text-gray-500');
                stopStatusPolling();
                console.log('Switching to config tab, loading configuration...');
                loadConfiguration();
            }
        }

        // Status polling
        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            updateStatus(); // Initial update
            statusInterval = setInterval(updateStatus, 2000);
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/backtest/status');
                const status = await response.json();
                
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                const details = document.getElementById('status-details');
                
                if (status.status === 'running_backtest') {
                    indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    text.textContent = 'Running';
                    details.innerHTML = `
                        <div>Phase: ${status.phase}</div>
                        <div>PID: ${status.pid}</div>
                        <div>Start Time: ${status.start_time}</div>
                        <div>Log Count: ${status.log_count}</div>
                    `;
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    // Hide results section when backtest is running
                    document.getElementById('results-section').style.display = 'none';
                } else if (status.status === 'downloading_data') {
                    indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
                    text.textContent = 'Downloading Data';
                    
                    // Build enhanced status details with symbol and timeframe info
                    let detailsHTML = `<div>Phase: ${status.phase}</div>`;
                    
                    if (status.download_info) {
                        // Show symbols being downloaded
                        if (status.download_info.symbols && status.download_info.symbols.length > 0) {
                            const symbolsStr = status.download_info.symbols.join(', ');
                            detailsHTML += `<div><strong>Symbols:</strong> ${symbolsStr}</div>`;
                        }
                        
                        // Show date range
                        if (status.download_info.date_range) {
                            detailsHTML += `<div><strong>Date Range:</strong> ${status.download_info.date_range.start} to ${status.download_info.date_range.end}</div>`;
                        }
                        
                        // Show download progress
                        if (status.download_info.progress && status.download_info.progress.current_step) {
                            const progress = status.download_info.progress;
                            detailsHTML += `<div><strong>Progress:</strong> Step ${progress.current_step} of ${progress.total_steps}</div>`;
                            detailsHTML += `<div><strong>Current:</strong> ${progress.current_resolution} - ${progress.current_symbols}</div>`;
                        }
                    }
                    
                    detailsHTML += `<div>Start Time: ${status.start_time}</div>`;
                    detailsHTML += `<div>Log Count: ${status.log_count}</div>`;
                    
                    details.innerHTML = detailsHTML;
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    // Hide results section when downloading data
                    document.getElementById('results-section').style.display = 'none';
                } else if (status.status === 'starting') {
                    indicator.className = 'w-3 h-3 rounded-full bg-blue-500';
                    text.textContent = 'Starting';
                    details.innerHTML = `
                        <div>Phase: ${status.phase}</div>
                        <div>Start Time: ${status.start_time}</div>
                    `;
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    // Hide results section when starting
                    document.getElementById('results-section').style.display = 'none';
                } else if (status.status === 'completed') {
                    indicator.className = 'w-3 h-3 rounded-full bg-green-600';
                    text.textContent = 'Completed';
                    details.innerHTML = `
                        <div>Backtest completed successfully</div>
                        <div>Total Duration: ${status.total_duration || 'N/A'}</div>
                        <div>End Time: ${status.end_time}</div>
                    `;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                    
                    // Automatically display results when backtest completes
                    if (document.getElementById('results-section').style.display === 'none') {
                        viewResults();
                    }
                } else if (status.status === 'error') {
                    indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                    text.textContent = 'Error';
                    details.innerHTML = `
                        <div>Backtest failed</div>
                        <div>End Time: ${status.end_time}</div>
                    `;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                } else {
                    indicator.className = 'w-3 h-3 rounded-full bg-gray-400';
                    text.textContent = 'Idle';
                    details.innerHTML = '<div>No active backtest</div>';
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                }
            } catch (error) {
                console.error('Failed to fetch status:', error);
            }
        }


        // Backtest controls
        async function startBacktest() {
            try {
                // Clear previous results to avoid confusion
                document.getElementById('results-section').style.display = 'none';
                document.getElementById('stats-content').innerHTML = '';
                document.getElementById('equity-chart').innerHTML = '';
                document.getElementById('orders-table').innerHTML = '';
                currentResults = null;
                document.getElementById('download-report-btn').disabled = true;
                
                const response = await fetch('/api/backtest/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                console.log('Backtest started:', result);
                updateStatus();
            } catch (error) {
                console.error('Failed to start backtest:', error);
                alert('Failed to start backtest');
            }
        }

        async function stopBacktest() {
            try {
                const response = await fetch('/api/backtest/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                console.log('Backtest stopped:', result);
                updateStatus();
            } catch (error) {
                console.error('Failed to stop backtest:', error);
                alert('Failed to stop backtest');
            }
        }

        async function viewResults() {
            try {
                const response = await fetch('/api/backtest/results');
                if (!response.ok) {
                    throw new Error('No results available');
                }
                const results = await response.json();
                console.log('Results loaded:', results);
                
                // Display results section
                displayResults(results);
                
                // Show results section
                document.getElementById('results-section').style.display = 'block';
                
                // Scroll to results
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Failed to fetch results:', error);
                alert('Failed to load results. Please ensure a backtest has completed successfully.');
            }
        }

        function displayResults(results) {
            // Store current results globally
            currentResults = results;
            
            // Enable download button
            document.getElementById('download-report-btn').disabled = false;
            
            // Display performance statistics
            const statsContent = document.getElementById('stats-content');
            const statistics = results.statistics || {};
            
            // Format numbers for display
            const formatNumber = (value, decimals = 2) => {
                if (value === null || value === undefined || value === '') return 'N/A';
                // Handle percentage strings like "37.970%" by removing % and converting
                if (typeof value === 'string' && value.includes('%')) {
                    const num = parseFloat(value.replace('%', ''));
                    if (isNaN(num)) return 'N/A';
                    return num.toFixed(decimals) + '%';
                }
                const num = parseFloat(value);
                if (isNaN(num)) return 'N/A';
                return num.toLocaleString(undefined, { 
                    minimumFractionDigits: decimals, 
                    maximumFractionDigits: decimals 
                });
            };
            
            const formatCurrency = (value) => {
                if (value === null || value === undefined || value === '') return 'N/A';
                // Handle percentage strings like "37.970%" - convert to dollar amount
                if (typeof value === 'string' && value.includes('%')) {
                    const percent = parseFloat(value.replace('%', ''));
                    if (isNaN(percent)) return 'N/A';
                    // Assuming starting equity from the data to calculate actual profit
                    const startEquity = parseFloat(statistics['Start Equity']) || 50000;
                    const profitAmount = (startEquity * percent) / 100;
                    return '$' + profitAmount.toLocaleString(undefined, { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                }
                const num = parseFloat(value);
                if (isNaN(num)) return 'N/A';
                return '$' + num.toLocaleString(undefined, { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            };
            
            statsContent.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-blue-600">Net Profit</div>
                    <div class="text-2xl font-bold text-blue-900">${formatCurrency(statistics['Net Profit'])}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-green-600">Sharpe Ratio</div>
                    <div class="text-2xl font-bold text-green-900">${formatNumber(statistics['Sharpe Ratio'])}</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-orange-600">Win Rate</div>
                    <div class="text-2xl font-bold text-orange-900">${formatNumber(statistics['Win Rate'])}</div>
                </div>
            `;

            // Create equity curve chart
            if (results.charts && results.charts['Strategy Equity'] && results.charts['Strategy Equity'].series && results.charts['Strategy Equity'].series.Equity) {
                const equityData = results.charts['Strategy Equity'].series.Equity.values;
                
                // Parse the equity data - each point is [timestamp, open, high, low, close]
                const dates = equityData.map(point => new Date(point[0] * 1000));
                const values = equityData.map(point => point[4]); // Use close value
                
                const trace = {
                    x: dates,
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio Value',
                    line: { color: '#3B82F6', width: 2 }
                };
                
                const layout = {
                    title: 'Portfolio Equity Curve',
                    xaxis: { 
                        title: 'Date',
                        showgrid: true
                    },
                    yaxis: { 
                        title: 'Portfolio Value ($)',
                        showgrid: true,
                        tickformat: '$,.0f'
                    },
                    margin: { l: 60, r: 50, t: 50, b: 50 },
                    showlegend: false
                };
                
                Plotly.newPlot('equity-chart', [trace], layout, {responsive: true});
            } else {
                // If no equity data, show a message
                document.getElementById('equity-chart').innerHTML = '<div class="text-center text-gray-500 p-8">No equity curve data available</div>';
            }



            // Display trades table
            if (results.totalPerformance && results.totalPerformance.closedTrades) {
                const trades = results.totalPerformance.closedTrades;
                
                // Sort trades by entry time (most recent first)
                trades.sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));
                
                // Display all trades
                const displayTrades = trades;
                
                const tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direction</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entry Time</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exit Time</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entry Price</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exit Price</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P&L</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${displayTrades.map(trade => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${trade.symbol.value}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                                            <span class="px-2 py-1 text-xs rounded-full ${trade.direction === 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${trade.direction === 0 ? 'Long' : 'Short'}
                                            </span>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${new Date(trade.entryTime).toLocaleString('en-US', {timeZone: 'America/New_York'})}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${new Date(trade.exitTime).toLocaleString('en-US', {timeZone: 'America/New_York'})}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${trade.quantity}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">$${trade.entryPrice.toFixed(2)}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">$${trade.exitPrice.toFixed(2)}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium ${trade.profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${trade.duration}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('orders-table').innerHTML = tableHTML;
            } else {
                document.getElementById('orders-table').innerHTML = '<div class="text-center text-gray-500 p-8">No trade data available</div>';
            }
        }

        // Auto-save debouncing
        let saveTimeout = null;
        let isLoading = false;

        // Configuration management
        async function loadConfiguration() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                updateSaveStatus('Loading...', 'text-blue-600');
                console.log('Fetching configuration from /api/config...');
                const response = await fetch('/api/config');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const config = await response.json();
                console.log('Loaded configuration:', config);
                currentConfig = config;
                
                // Populate form fields
                Object.keys(config).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = config[key];
                        } else {
                            element.value = config[key];
                        }
                    }
                });
                
                // Handle symbols separately
                if (config.symbols) {
                    currentSymbols = Array.isArray(config.symbols) ? config.symbols : [];
                    updateSymbolsDisplay();
                }
                
                updateSaveStatus('Auto-save: Ready', 'text-gray-600');
                console.log('Configuration loaded');
            } catch (error) {
                console.error('Failed to load configuration:', error);
                updateSaveStatus('Auto-save: Load failed', 'text-red-600');
            } finally {
                isLoading = false;
            }
        }

        async function saveConfiguration() {
            if (isLoading) return;
            
            try {
                updateSaveStatus('Saving...', 'text-blue-600');
                
                const formData = new FormData(document.getElementById('configForm'));
                const config = {};
                
                // First, process all form data entries
                for (let [key, value] of formData.entries()) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            config[key] = element.checked;
                        } else if (element.type === 'number') {
                            config[key] = parseFloat(value) || 0;
                        } else {
                            config[key] = value;
                        }
                    }
                }
                
                // Then, ensure all checkboxes are included (even unchecked ones)
                const checkboxes = ['C1', 'C2', 'C3', 'C4', 'C5', 'Allow_Actions'];
                checkboxes.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        config[id] = checkbox.checked;
                    }
                });
                
                // Add symbols
                config.symbols = currentSymbols;
                
                // Update current config
                currentConfig = config;
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                updateSaveStatus('Auto-save: Saved', 'text-green-600');
                console.log('Configuration auto-saved:', result);
                
                // Reset status after 2 seconds
                setTimeout(() => {
                    updateSaveStatus('Auto-save: Ready', 'text-gray-600');
                }, 2000);
                
            } catch (error) {
                console.error('Failed to save configuration:', error);
                updateSaveStatus('Auto-save: Failed', 'text-red-600');
            }
        }

        function updateSaveStatus(message, className) {
            const statusElement = document.getElementById('save-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `text-sm ${className}`;
            }
        }

        function debouncedSave() {
            if (isLoading) return; // Don't save during loading
            
            // Clear existing timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Set new timeout for 1 second
            saveTimeout = setTimeout(() => {
                saveConfiguration();
            }, 1000);
            
            // Update status immediately
            updateSaveStatus('Auto-save: Pending...', 'text-yellow-600');
        }

        // Symbol management
        function updateSymbolsDisplay() {
            const container = document.getElementById('symbols-container');
            container.innerHTML = '';
            
            currentSymbols.forEach(symbol => {
                const badge = document.createElement('span');
                badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 mr-2 mb-2';
                badge.innerHTML = `
                    ${symbol}
                    <button type="button" class="ml-2 text-blue-600 hover:text-blue-800" onclick="removeSymbol('${symbol}')">√ó</button>
                `;
                container.appendChild(badge);
            });
            
            // Update hidden input
            document.getElementById('symbols').value = JSON.stringify(currentSymbols);
        }

        function addSymbol(symbol) {
            symbol = symbol.toUpperCase().trim();
            if (symbol && !currentSymbols.includes(symbol)) {
                currentSymbols.push(symbol);
                updateSymbolsDisplay();
                debouncedSave(); // Auto-save when symbols change
            }
        }

        function removeSymbol(symbol) {
            currentSymbols = currentSymbols.filter(s => s !== symbol);
            updateSymbolsDisplay();
            debouncedSave(); // Auto-save when symbols change
        }

        // Download Backtest Report function
        async function downloadBacktestReport() {
            if (!currentResults || !currentConfig) {
                alert('No results available to download');
                return;
            }

            try {
                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const lineHeight = 7;
                const pageHeight = doc.internal.pageSize.height;
                const marginBottom = 20;
                
                // Helper function to check if we need a new page
                function checkNewPage(requiredSpace = lineHeight) {
                    if (yPosition + requiredSpace > pageHeight - marginBottom) {
                        doc.addPage();
                        yPosition = 20;
                        return true;
                    }
                    return false;
                }
                
                // Title page
                doc.setFontSize(20);
                doc.text('Backtest Report', 105, yPosition, { align: 'center' });
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, yPosition, { align: 'center' });
                yPosition += 20;
                
                // Configuration Section
                doc.setFontSize(16);
                doc.text('Configuration', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                
                // General Parameters
                doc.setFont(undefined, 'bold');
                doc.text('General Parameters:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Starting Cash: $${currentConfig.starting_cash?.toLocaleString() || 'N/A'}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Start Date: ${currentConfig.start_date || 'N/A'}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`End Date: ${currentConfig.end_date || 'N/A'}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Symbols: ${currentConfig.symbols?.join(', ') || 'N/A'}`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Trading Parameters
                checkNewPage(lineHeight * 8);
                doc.setFont(undefined, 'bold');
                doc.text('Trading Parameters:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                for (let i = 1; i <= 5; i++) {
                    doc.text(`Parameter ${i}: ${currentConfig[`Parameter_${i}`] || 'N/A'}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                yPosition += lineHeight;
                
                // Conditions
                checkNewPage(lineHeight * 7);
                doc.setFont(undefined, 'bold');
                doc.text('Conditions Enabled:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                for (let i = 1; i <= 5; i++) {
                    const enabled = currentConfig[`C${i}`] ? 'Yes' : 'No';
                    doc.text(`Condition ${i}: ${enabled}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                yPosition += lineHeight;
                
                // Profit Take Settings
                checkNewPage(lineHeight * 7);
                doc.setFont(undefined, 'bold');
                doc.text('Profit Take Settings:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                for (let i = 1; i <= 5; i++) {
                    doc.text(`Profit Take C${i}: ${currentConfig[`ProfitTakeC${i}`]}%`, 25, yPosition);
                    yPosition += lineHeight;
                }
                yPosition += lineHeight;
                
                // Risk Management
                checkNewPage(lineHeight * 5);
                doc.setFont(undefined, 'bold');
                doc.text('Risk Management:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Stop Loss: ${currentConfig.StopLoss}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Shares to Sell: ${currentConfig.SharesToSell}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Offset PCT: ${currentConfig.OffsetPCT}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Max Daily PNL: ${currentConfig.Max_Daily_PNL}%`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Timing Constraints
                checkNewPage(lineHeight * 8);
                doc.setFont(undefined, 'bold');
                doc.text('Timing Constraints:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Same Symbol Time: ${currentConfig.SameSymbolTime}`, 25, yPosition);
                yPosition += lineHeight;
                for (let i = 1; i <= 5; i++) {
                    doc.text(`Same Condition Time C${i}: ${currentConfig[`SameConditionTimeC${i}`]}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                yPosition += lineHeight;
                
                // Stop Loss X/Y Parameters
                checkNewPage(lineHeight * 12);
                doc.setFont(undefined, 'bold');
                doc.text('Stop Loss X/Y Parameters:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                for (let i = 1; i <= 5; i++) {
                    doc.text(`Stop Loss X C${i}: ${currentConfig[`StopLossXC${i}`]}`, 25, yPosition);
                    yPosition += lineHeight;
                    doc.text(`Stop Loss Y C${i}: ${currentConfig[`StopLossYC${i}`]}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                doc.text(`Stop Loss Update: ${currentConfig.StopLossUpdate}`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Capital Management
                checkNewPage(lineHeight * 4);
                doc.setFont(undefined, 'bold');
                doc.text('Capital Management:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Cash PCT: ${currentConfig.cash_pct}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Max Capital PCT: ${currentConfig.MaxCapitalPCT}%`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // VWAP Settings
                checkNewPage(lineHeight * 4);
                doc.setFont(undefined, 'bold');
                doc.text('VWAP Settings:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`VWAP PCT: ${currentConfig.VWAP_PCT}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`VWAP Margin: ${currentConfig.Vwap_Margin}%`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Rally Conditions
                checkNewPage(lineHeight * 7);
                doc.setFont(undefined, 'bold');
                doc.text('Rally Conditions:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Rally X Min PCT: ${currentConfig.Rally_X_Min_PCT}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Rally X Max PCT: ${currentConfig.Rally_X_Max_PCT}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Rally Y PCT: ${currentConfig.Rally_Y_PCT}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Rally Time Constraint: ${currentConfig.Rally_Time_Constraint}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Rally Time Constraint Threshold: ${currentConfig.Rally_Time_Constraint_Threshold}%`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Action Timing
                checkNewPage(lineHeight * 5);
                doc.setFont(undefined, 'bold');
                doc.text('Action Timing:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Allow Actions: ${currentConfig.Allow_Actions ? 'Yes' : 'No'}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Action 1 Time: ${currentConfig.Action1_Time}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Action 2 Time: ${currentConfig.Action2_Time}`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Market Hours
                checkNewPage(lineHeight * 4);
                doc.setFont(undefined, 'bold');
                doc.text('Market Hours:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`Algo Off Before: ${currentConfig.Algo_Off_Before}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Algo Off After: ${currentConfig.Algo_Off_After}`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // Advanced Settings
                checkNewPage(lineHeight * 8);
                doc.setFont(undefined, 'bold');
                doc.text('Advanced Settings:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                doc.text(`New Range Order Cancellation Margin: ${currentConfig.New_Range_Order_Cancellation_Margin}%`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Range Multiple Threshold: ${currentConfig.RangeMultipleThreshold}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Liquidity Threshold: ${currentConfig.Liquidity_Threshold}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Gap Threshold: ${currentConfig.Gap_Threshold}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Sharp Movement Threshold: ${currentConfig.SharpMovement_Threshold}`, 25, yPosition);
                yPosition += lineHeight;
                doc.text(`Sharp Movement Minutes: ${currentConfig.SharpMovement_Minutes}`, 25, yPosition);
                yPosition += lineHeight * 2;
                
                // New page for results
                doc.addPage();
                yPosition = 20;
                
                // Results Section
                doc.setFontSize(16);
                doc.text('Backtest Results', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                const statistics = currentResults.statistics || {};
                
                // Performance Summary
                doc.setFont(undefined, 'bold');
                doc.text('Performance Summary:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                // Helper function to format values
                const formatValue = (value) => {
                    if (value === null || value === undefined || value === '') return 'N/A';
                    if (typeof value === 'string' && value.includes('%')) {
                        return value;
                    }
                    const num = parseFloat(value);
                    if (isNaN(num)) return 'N/A';
                    return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };
                
                // Only add non-N/A values and exclude specific parameters
                const netProfit = formatValue(statistics['Net Profit']);
                if (netProfit !== 'N/A') {
                    doc.text(`Net Profit: $${netProfit}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                
                // Skip Total Return - removed per request
                
                const sharpeRatio = formatValue(statistics['Sharpe Ratio']);
                if (sharpeRatio !== 'N/A') {
                    doc.text(`Sharpe Ratio: ${sharpeRatio}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                
                const winRate = formatValue(statistics['Win Rate']);
                if (winRate !== 'N/A') {
                    doc.text(`Win Rate: ${winRate}%`, 25, yPosition);
                    yPosition += lineHeight;
                }
                
                // Skip Total Trades, Winning Trades, Losing Trades - removed per request
                
                yPosition += lineHeight;
                
                // Risk Metrics
                checkNewPage(lineHeight * 6);
                doc.setFont(undefined, 'bold');
                doc.text('Risk Metrics:', 20, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += lineHeight;
                
                const drawdown = formatValue(statistics['Drawdown']);
                if (drawdown !== 'N/A') {
                    doc.text(`Maximum Drawdown: ${drawdown}%`, 25, yPosition);
                    yPosition += lineHeight;
                }
                
                const avgWin = formatValue(statistics['Average Win']);
                if (avgWin !== 'N/A') {
                    doc.text(`Average Win: $${avgWin}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                
                const avgLoss = formatValue(statistics['Average Loss']);
                if (avgLoss !== 'N/A') {
                    doc.text(`Average Loss: $${avgLoss}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                
                // Skip Profit Factor - removed per request
                
                yPosition += lineHeight;
                
                // Capture equity chart as image
                checkNewPage(100);
                const equityChartDiv = document.getElementById('equity-chart');
                if (equityChartDiv && equityChartDiv.querySelector('.plot-container')) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Equity Curve:', 20, yPosition);
                    yPosition += lineHeight;
                    
                    try {
                        const canvas = await html2canvas(equityChartDiv, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        const imgData = canvas.toDataURL('image/png');
                        doc.addImage(imgData, 'PNG', 20, yPosition, 170, 80);
                        yPosition += 85;
                    } catch (chartError) {
                        doc.setFont(undefined, 'normal');
                        doc.text('(Chart could not be captured)', 25, yPosition);
                        yPosition += lineHeight;
                    }
                }
                
                // Trade Summary (all trades)
                doc.addPage();
                yPosition = 20;
                
                doc.setFontSize(16);
                doc.text('Complete Trade History', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(8);
                if (currentResults.totalPerformance && currentResults.totalPerformance.closedTrades) {
                    const trades = currentResults.totalPerformance.closedTrades;
                    
                    // Table headers
                    doc.setFont(undefined, 'bold');
                    doc.text('Symbol', 20, yPosition);
                    doc.text('Direction', 45, yPosition);
                    doc.text('Entry', 70, yPosition);
                    doc.text('Exit', 95, yPosition);
                    doc.text('Qty', 120, yPosition);
                    doc.text('P&L', 140, yPosition);
                    doc.text('Duration', 160, yPosition);
                    doc.setFont(undefined, 'normal');
                    yPosition += lineHeight;
                    
                    trades.forEach(trade => {
                        checkNewPage(lineHeight);
                        doc.text(trade.symbol.value, 20, yPosition);
                        doc.text(trade.direction === 0 ? 'Long' : 'Short', 45, yPosition);
                        doc.text(`$${trade.entryPrice.toFixed(2)}`, 70, yPosition);
                        doc.text(`$${trade.exitPrice.toFixed(2)}`, 95, yPosition);
                        doc.text(trade.quantity.toString(), 120, yPosition);
                        
                        const plColor = trade.profitLoss >= 0 ? [0, 128, 0] : [255, 0, 0];
                        doc.setTextColor(...plColor);
                        doc.text(`$${trade.profitLoss.toFixed(2)}`, 140, yPosition);
                        doc.setTextColor(0, 0, 0);
                        
                        doc.text(trade.duration, 160, yPosition);
                        yPosition += lineHeight;
                    });
                    
                    // Add summary at the end
                    yPosition += lineHeight;
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total Trades: ${trades.length}`, 20, yPosition);
                    doc.setFont(undefined, 'normal');
                }
                
                // Save the PDF
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                doc.save(`backtest-report-${timestamp}.pdf`);
                
            } catch (error) {
                console.error('Failed to generate PDF:', error);
                alert('Failed to generate PDF report. Please try again.');
            }
        }

        // Check and load results if available
        async function checkAndLoadResults() {
            try {
                // First load configuration
                const configResponse = await fetch('/api/config');
                if (configResponse.ok) {
                    currentConfig = await configResponse.json();
                }
                
                // Check current status before loading results
                const statusResponse = await fetch('/api/backtest/status');
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    
                    // Only load results if backtest is completed
                    if (status.status === 'completed') {
                        const response = await fetch('/api/backtest/results');
                        if (response.ok) {
                            // Results are available, load them
                            const results = await response.json();
                            displayResults(results);
                            document.getElementById('results-section').style.display = 'block';
                        }
                    } else {
                        // Hide results if backtest is in any other state
                        document.getElementById('results-section').style.display = 'none';
                    }
                }
            } catch (error) {
                // No results available, which is fine
                console.log('No results available on page load');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Backtest controls
            document.getElementById('start-btn').addEventListener('click', startBacktest);
            document.getElementById('stop-btn').addEventListener('click', stopBacktest);
            document.getElementById('download-report-btn').addEventListener('click', downloadBacktestReport);
            
            // Symbol management
            document.getElementById('add-symbol-btn').addEventListener('click', function() {
                const input = document.getElementById('new-symbol-input');
                addSymbol(input.value);
                input.value = '';
            });
            
            document.getElementById('new-symbol-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addSymbol(this.value);
                    this.value = '';
                }
            });
            
            // Quick add symbols
            document.querySelectorAll('.quick-add-symbol').forEach(btn => {
                btn.addEventListener('click', function() {
                    addSymbol(this.dataset.symbol);
                });
            });
            
            // Auto-save on form input changes
            document.getElementById('configForm').addEventListener('input', function(e) {
                // Only trigger auto-save for actual form inputs, not hidden fields
                if (e.target.type !== 'hidden') {
                    debouncedSave();
                }
            });
            
            // Auto-save on checkbox changes
            document.getElementById('configForm').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    debouncedSave();
                }
            });
            
            // Start with backtest tab and begin status polling
            switchTab('backtest');
            
            // Check if results are available on page load
            checkAndLoadResults();
        });
    </script>
</body>
</html>